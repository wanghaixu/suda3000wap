<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
	<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
	<title>销售订单</title>
	<link rel="stylesheet" type="text/css" href="../../css/ui-base.css">
	<link rel="stylesheet" type="text/css" href="../../css/layer.css">
	<link rel="stylesheet" type="text/css" href="../../css/mobiscroll.2.13.2.min.css">
	<link rel="stylesheet" type="text/css" href="../../css/public.css">
	<link rel="stylesheet" type="text/css" href="../../css/base_index.css">
</head>
<body class="uhide">
	<header class="ub ub-pc ub-ac module-header-t1 bg-fixed2 line-b">
		<a id="backBtn" class="ub ub-ac">
            <div class="icon back-icon-wh"></div>
            <div class="tx-16 tx-wh">返回</div>
        </a>
		<div class="ub-f1 ub ub-ac ub-pc tx-18">销售订单</div>
		 <div class="ub ub-ac ub-pe title-r">
			<a id="listBtn" class="icon list-icon-wh"></a>
			<div id="submitBtn" class="icon post-icon-wh marl-10"></div>
		</div>
	</header>
	<div class="mart-5 padt-44">
		<section class="ub ub-ver marb-5 bg-wh line-t line-b">
			<div class="padlr-15 bg-f8-active">
				<div class="ub ub-ac h-44 line-b">
					<div class="item-tilte itemName tx-l tx-bla">日期</div>
					<div class="ub ub-ac ub-f1 tx-r tx-gray">
						<input id="billDate" data-kname="billdate" class="billInput ub-f1 tx-r" type="text" readonly>
					</div>
				</div>
			</div>
			<div class="padlr-15">
				<div class="ub ub-ac h-44 line-b">
					<div class="item-tilte itemName tx-l tx-bla">单号</div>
					<div class="ub ub-ac ub-f1 tx-r tx-gray">
						<input id="billCode" data-kname="code" class="billInput ub-f1 tx-r" type="text">
					</div>
				</div>
			</div>
			<div id="chooseTraderBtn" class="padlr-15 bg-f8-active">
				<div class="ub ub-ac h-44 line-b">
					<div id="traderType" class="item-tilte itemName tx-l tx-bla">客户</div>
					<div class="ub ub-ac ub-f1 tx-r tx-gray">
						<input id="traderName" data-kid="clientid" data-kname="clientshortname" class="billInput ub-f1 tx-r" type="text" readonly>
						<div class="rightArrow"></div>
					</div>
				</div>
			</div>
			<div class="padlr-15 bg-f8-active">
				<div class="ub ub-ac h-44">
					<div id="dateType" class="item-tilte itemName tx-l tx-bla">到货日期</div>
					<div class="ub ub-ac ub-f1 tx-r tx-gray">
						<input id="revDate" data-kname="revdate" class="billInput ub-f1 tx-r" value="" type="text" readonly>
					</div>
				</div>
			</div>
		</section>
		<section class="ub ub-ver line-t line-b bg-wh marb-5">
			<div class="list-item ub-f1 ub">
				<div class="itemName tx-l tx-bla">中止</div>
				<div class="ub-f1 tx-r tx-gray">
					<label class="switch" >
						<input id="closed" data-kid="closed" type="checkbox" class="switchBtn">
					</label>
				</div>
			</div>
		</section>
		<section class="ub ub-ver line-t line-b bg-wh marb-5">
			<div class="padlr-15">
				<div class="ub ub-ac h-44 line-b">
					<div class="item-tilte itemName tx-l tx-bla">摘要</div>
					<div class="ub ub-ac ub-f1 tx-r tx-gray">
						<input id="remark" data-kname="memo" class="billInput ub-f1 tx-r" type="text">
					</div>
				</div>
			</div>
			<div class="padlr-15 bg-f8-active">
				<div class="ub ub-ac h-44 line-b">
					<div class="item-tilte itemName tx-l">项目</div>
					<label for="projectName" class="ub ub-ac ub-f1 tx-r tx-gray sel-label">
						<div class="ub-f1"></div>
						<select id="projectName" dat-kid="projectid" data-kname="projectname" class="hide sel-opt"></select>
						<div class="rightArrow"></div>
					</label>
				</div>
			</div>
			<div class="padlr-15 bg-f8-active">
				<div class="ub ub-ac h-44 line-b">
					<div class="item-tilte itemName tx-l">部门</div>
					<label for="depName" class="ub ub-ac ub-f1 tx-r tx-gray sel-label">
						<div class="ub-f1"></div>
						<select id="depName" data-kid="departmentid" data-kname="deptname" class="hide sel-opt"></select>
						<div class="rightArrow"></div>
					</label>
				</div>
			</div>
			<div class="padlr-15 bg-f8-active">
				<div class="ub ub-ac h-44">
					<div class="item-tilte itemName tx-l">员工</div>
					<label for="empName" class="ub ub-ac ub-f1 tx-r tx-gray sel-label scroll">
						<div class="ub-f1"></div>
						<select id="empName" data-kid="exemanid" data-kname="exemanname" class="hide sel-opt">
							<option data-id=""  selected></option>
						</select>
						<div class="rightArrow"></div>
					</label>
				</div>
			</div>
		</section>
		<section class="ub ub-ver marb-5 bg-wh line-t">
			<div id="chooseGoodsBtn" class="padlr-15 bg-f8-active" data-on="1">
				<div class="ub ub-ac ub-f1 h-44 line-b">
					<div class="item-tilte itemName tx-l tx-bla">选择货品</div>
					<div class="ub ub-ac ub-pe ub-f1 tx-r tx-gray">
						<div class="rightArrow"></div>
					</div>
				</div>
			</div>
			<div id="listDetail"></div>
			<div class="padlr-15">
				<div class="ub-f1 ub ub-ac h-44">
					<div class="itemName tx-l tx-bla">合计</div>
					<div class=" ub-f1 ut-s tx-r tx-bla bold">
						<span id="moneyCode">￥</span><span id="amount">0</span>
					</div>
				</div>
			</div>
		</section>
		<div id="delBtn" class="longButton danger ub-f1 hide">删&nbsp;除</div>
	</div>
</body>
<script type="text/javascript" src="../../js/sea.js"></script>
<script>
var type = 'sale_order';//Url地址键名
seajs.use(['zepto.min', 'public', 'base_index','save' ,'layer', 'mobiscroll.2.13.2.min'],function(zepto, _Public, base_index,Save_order){
	/**
	 * 接收传递参数
	 */
	var action = base_index.getPageParams('action') || '';//操作模式
	var billId = base_index.getPageParams('billId') || '';//单据id

	//修改地址
	var prevDetailPageName = sessionStorage.getItem('session_prevDetailPageName') || '';
	if(prevDetailPageName != base_index.detailPageName[type]){
		console.log('detailPageName：'+base_index.detailPageName[type]);
		sessionStorage.removeItem('session_billDataJson');
		sessionStorage.removeItem('session_temp_billDataJson');//临时编辑数据缓存
		sessionStorage.removeItem('session_traderJson');//（联动数据）供应商/客户/结算单位
		sessionStorage.setItem('session_prevDetailPageName', base_index.detailPageName[type]);
	}
	//修改参数
	var prevBillAction = sessionStorage.getItem('session_prevBillAction') || '';
	if(prevBillAction != action){
		console.log('action：'+action);
		sessionStorage.removeItem('session_billDataJson');
		sessionStorage.removeItem('session_temp_billDataJson');//临时编辑数据缓存
		sessionStorage.removeItem('session_traderJson');//（联动数据）供应商/客户/结算单位
		sessionStorage.setItem('session_prevBillAction', action);
	}
	//修改单据id
	if(action=='edit' && billId!='' && billId!=sessionStorage.getItem('session_billId')){
		console.log('修改单据id');
		sessionStorage.removeItem('session_temp_billDataJson');//临时编辑数据缓存
		sessionStorage.removeItem('session_traderJson');//（联动数据）供应商/客户/结算单位
	}

	/**
	 * 请求参数
	 */
	var ipUrl='http://'+_Public.Get_storage('sdIP');//接口IP
	var editUrl = ipUrl + base_index.billEditUrl[type];//编辑接口地址
	var addUrl = ipUrl + base_index.billAddUrl[type];//添加接口地址
	var delUrl = ipUrl + base_index.billDelUrl[type];//删除接口地址
	var saveUrl= ipUrl + base_index.billSaveUrl[type];//保存接口地址
	var master_backup={};//页面数据备份变量
	var isAdd = true;//是否为新增模式
	var bill_id='';//编辑模式时，记录单据id
	var del_detail={};//编辑状态下的原有detail备份
	var choose_trader=false;//判断是否选择不同的供应商
	var delDetail_count=0;  //选择不同的供应商，记录删除的detail条数
	/**
	 * 初始化下拉选择数据
	 */
	base_index.getBaseData($('#projectName'), 'project', 'project');//项目
	base_index.getBaseData($('#depName'), 'department', 'base');//部门
	base_index.getBaseData($('#empName'), 'employ', 'employ');//业务员

    /**
     * 数据处理
     */
	if(action=='edit'){
		/*
		* 编辑模式
		*/
		isAdd =false;
		if(billId!='' && billId!=sessionStorage.getItem('session_billId') || !sessionStorage.getItem('session_temp_billDataJson') && billId!=''){
			sessionStorage.setItem('session_billId', billId);
			//输入参数
			var dataStr = {
				'billId': billId
			}
			//设置参数
			var dataCommand = base_index.DataCommand(editUrl, 'get', dataStr);
			//发送请求，返回数据
			dataCommand.init(
				function(ret){
					if(ret.errNo){
						//提示错误信息弹窗
                        _Public.closeToLogin(ret.errMsg);
					}else {
						sessionStorage.removeItem('session_traderJson');
						sessionStorage.removeItem('session_billDataJson');
						sessionStorage.removeItem('session_wasChange');
						/**
						 * 货品需要参数
						 */
						var rdetail1 = ret.detail1;
						for(var k = 0; k< rdetail1.length; k++){
							ret.detail1[k].log_oldGoods = 'true';
							ret.detail1[k].log_attr = 'old';
							ret.detail1[k].log_id = k;
						}
						sessionStorage.setItem('session_billDataJson', JSON.stringify(ret));
						succFuncEdit(ret);
					}
				}, function(ret){
					_Public.layerMsg(ret.msg);
				}
			);
		}else if(sessionStorage.getItem('session_temp_billDataJson')){
			console.log('edit-old');
			var rets = sessionStorage.getItem('session_temp_billDataJson') || '';
			console.log(rets);
			rets = JSON.parse(rets);
			succFuncEdit(rets);
		}
	}else if(action=='add'){
		/*
		 * 新增模式
		 */
		if(sessionStorage.getItem('session_temp_billDataJson') && sessionStorage.getItem('session_wasChange')){
			console.log('add-old');
			var rets = sessionStorage.getItem('session_temp_billDataJson') || '';
			console.log(rets);
			rets = JSON.parse(rets);
			succFuncEdit(rets);
		}else{
			//设置参数
			var dataCommand = base_index.DataCommand(addUrl, 'get');
			//发送请求，返回数据
			var ret = dataCommand.init(
				function(ret){
					if(ret.errNo){
						//提示错误信息弹窗
                        _Public.closeToLogin(ret.errMsg);
					}else{
						sessionStorage.removeItem('session_traderJson');
						sessionStorage.removeItem('session_billDataJson');
						sessionStorage.removeItem('session_wasChange');
						sessionStorage.setItem('session_billDataJson', JSON.stringify(ret));
						/**
						 * 设置页面参数
						 */
						succFuncAdd(ret);
					}
				}, function(ret){
					_Public.hideProgress();
					_Public.layerMsg(ret.msg);
				}
			);
		}
		$('#delBtn').addClass('hide');//隐藏按钮
	}

	/**
	 * 初始化页面事件
	 */
	//后退
	$('#backBtn').on('tap', function(){
		if(action=='edit'){
			console.log(action);
			window.location.href = base_index.listPageName[type];
		}else if(action=='add'){
			console.log(action);
			window.location.href = './index.html';
		}else{
			history.back();
		}
	});
	//进入列表按钮
	$('#listBtn').on('tap', function(){
		var billAction = action;
		if(action == 'check'){
			billAction = 'edit';
		}
		sessionStorage.setItem('session_billAction', 'add');
		window.location.href = 'sale_order.html?action='+billAction;
	});
	//点击进入选择商品页面
	$('#chooseGoodsBtn').on('tap', function(event){
		event.preventDefault();
		/**
		 * 货品选择需要参数
		 */
		if($(this).data('on')=='1'){
			var goodParamJson = {
			 	'traderID': $('#traderName').data('id') || 0,//客户或/供应商id
			 	'noteType': 3,//发票类型为“收据”是1，其他0
		 		'revDate': $('#revDate').val(),
				'storeID': -1//仓库id
			}
			base_index.tempSessionStorage();//临时缓存
			sessionStorage.setItem('session_goodParamJson', JSON.stringify(goodParamJson));
			sessionStorage.setItem('session_prevTraderId', $('#traderName').data('id'));//设置下次对比供应商/客户是否改变session
			window.location.href = './pro_choose.html?type='+type;
		}
	});
	//点击进入商品详情页面
	$(document).on('tap', '.goodsItem', function(event){
		event.preventDefault();
		/**
		 * 货品选择需要参数
		 */
		var goodParamJson = {
		 	'traderID': $('#traderName').data('id') || 0,//客户或/供应商id
		 	'noteType': 3,//发票类型为“收据”是1，其他0
	 		'revDate': $('#revDate').val(),
			'storeID': -1//仓库id
		}
		base_index.tempSessionStorage();//临时缓存
		sessionStorage.setItem('session_goodParamJson', JSON.stringify(goodParamJson));
		sessionStorage.setItem('session_prevTraderId', $('#traderName').data('id'));//设置下次对比供应商/客户是否改变session
        var goodsDataJson = $(this).attr('data-json');
		sessionStorage.setItem('goodsData', goodsDataJson);
		window.location.href = './pro_edit.html?type='+type+'&act=edit';
	});
	//选择供应商/客户
	$('#chooseTraderBtn').on('tap', function(event) {
		event.preventDefault();
		sessionStorage.setItem('session_billAction', action);
		base_index.tempSessionStorage();//临时缓存
		window.location.href = './trader_choose.html?type='+type;
	});

	/**
	 * 联动事件
	 */
    //初始化下拉选择框
	$('select').on('change', function(){
		$(this).prev('input').val($(this).val());
		$(this).data('id', base_index.getSelectedAttr($(this), 'data-id'));
		$(this).data('code', base_index.getSelectedAttr($(this), 'data-code'));
	});
	var traderJson = JSON.parse(sessionStorage.getItem('session_traderJson')) || '';
	var prevTraderId = sessionStorage.getItem('session_prevTraderId') || '';//上个供应商id/客户id
	//比较(供应商/客户)是否改变
	if(traderJson != ''){
		base_index.change_trader(traderJson);

		if(traderJson.traderId != prevTraderId){
			//设置供应商/客户联动数据
			//删除所有的商品HTML
			$('#listDetail').empty();
			//总价归零
			$('#amount').text(0);
			//清空商品数据
			var session_temp_billDataJson = sessionStorage.getItem('session_temp_billDataJson') || '';
			if(session_temp_billDataJson!=''){
				var temp_billDataJson = JSON.parse(session_temp_billDataJson);
				var detail1Json = temp_billDataJson.detail1;
				for(var k in detail1Json){
					detail1Json[k].log_attr = 'del';
				}
				$.extend(temp_billDataJson, detail1Json);
				sessionStorage.setItem('session_temp_billDataJson', JSON.stringify(temp_billDataJson));
			}
			//获取并设置会员信息（卡号、积分）
			if(type=='cash_sale'){
				var vipid = $('#traderName').data('vipid');
				base_index.getMemberData(vipid);
			}
		}
	}

	//成功处理函数
	function succFuncAdd(ret){
		//初始化html模板
		console.log(JSON.stringify(ret));
		if(ret.master && ret.detail1){
			/*把master的数据备份，保存时使用*/
			master_backup=Save_order.newMaster(ret.master,type);
			/**
			 * 设置页面参数
			 */
			_Public.selectDates($('#billDate'), ret.master.billdate || _Public.getDates().sDate);//日期
			_Public.selectDates($('#revDate'), ret.master.takedate || ret.master.revdate || _Public.getDates().sDate);//发货日期
			base_index.setValue($('#billCode'), ret.master.code);//单号
			$('#moneyName').attr('data-id', '0');//币种id
            _Public.hideProgress();
		}
	}
	function succFuncEdit(ret){
		/*获取数据，生成html*/
		//初始化html模板
		var htmlCommand = base_index.HtmlCommand(goodsListHtml);
		/*主单据*/
		var rmaster = ret.master || '';
		var rdetail1 = ret.detail1 || '';
		if(rmaster!=''){
			//把master的数据备份，保存时使用
			master_backup=Save_order.sortMaster(rmaster,type);
			/**
			 * 未审核状态
			 */
			//显示删除按钮
			$('#delBtn').removeClass('hide');
			//删除操作
			$('#delBtn').on('tap', function(event){
				event.preventDefault();
				_Public.confirmLayer('确定删除该单据', function(){
					layer.close();
					_Public.showLoading();
					var delDataStr = {
						'billId': billId,
						'checkStep': 0,
						'id': billId
					}
					var delDataCommand = base_index.DataCommand(delUrl, 'get', dataStr);
					//发送请求，返回数据
					delDataCommand.init(
						function(ret){
							if(ret.errNo){
								//提示错误信息弹窗
                       			_Public.closeToLogin(ret.errMsg);
							}else {
								_Public.hideProgress();
								_Public.layerMsg('删除成功!');
							}
						}, function(ret){
							_Public.hideProgress();
							_Public.layerMsg(ret.msg);
						}
					);
				}, function(){
					layer.close();
					_Public.hideProgress();
					_Public.layerMsg(ret.msg);
				});
			});
			/**
			 * 设置页面参数
			 */
			_Public.selectDates($('#billDate'), rmaster.billdate || _Public.getDates().sDate);//日期
			base_index.setValue($('#billCode'), rmaster.code || '');//单号
			base_index.setValue($('#traderName'), rmaster.clientshortname || '');//供应商/客户
			$('#traderName').attr('data-id', rmaster.clientid || '');//供应商id/客户id
			_Public.selectDates($('#revDate'), rmaster.takedate || ret.master.revdate || _Public.getDates().sDate);//发货日期
			//(是/否)中止状态
			if(rmaster.closed==1){
				$('#closed').attr('checked', true);
			}
			//是否已完成
            if (rmaster.finished==1) {
                base_index.offCheckboxBtn($('#closed'));//中止按钮不可用
            }
			base_index.setValue($('#remark'), rmaster.remark || '');//摘要
			base_index.setMobiscrollValue($('#projectName'), rmaster.projectname || '');//项目名
			$('#projectName').attr('data-id', rmaster.projectid || '');//项目id
			base_index.setMobiscrollValue($('#depName'), rmaster.depname || '');//部门
			$('#depName').attr('data-id', rmaster.departmentid || '');//部门id
			base_index.setMobiscrollValue($('#empName'), rmaster.exemanname || '');//员工
			$('#empName').attr('data-id', rmaster.exemanid || '');//员工id

			//判断价格正负数
			var amount = (rmaster.amount || '').toString();
			if(amount.indexOf('-')>-1){
				$('#amount').parent().addClass('tx-red');
				$('#amount').parent().removeClass('tx-bla');
			}
			base_index.setText($('#amount'), rmaster.amount || '0');//合计(价格)

			/*单据明细*/
			var rdetail1 = ret.detail1;
			for(var k = 0; k< rdetail1.length; k++){
				rdetail1[k].moneycode = rmaster.moneycode;
	    			htmlCommand.set(rdetail1[k]);//将数据填充到HTML模板
			}
			htmlCommand.appendIn($('#listDetail'));
		}
	}
	//HTML模版
	function goodsListHtml(json){
        var thisItem = $('<div></div>');
        var jsonStr = JSON.stringify(json);
        if(json.log_attr!='del'){
        thisItem.append($('<div class="goodsItem ub ub-ac line-b bg-f8-active oldGoods" data-attr="'+json.log_attr+'" data-id="'+json.log_id+'" data-oldGoods="'+json.log_oldGoods+'"><div class="itemName tx-bla ub ub-f1 ub-ver "><div class="marb-5 ub ub-f1 ub-pc"><div class="ub-f1">'+json.goodsname+'</div><div class="ub-f1 tx-gra tx-r"><span class="ub-f1 tx-gra tx-r">'+json.unitqty+''+json.unit+'</span></div></div><div class="tx-gray tx-12 ub ub-f1"><div class="ub-f1"><span>单价：￥</span><span class="goodsPrice">'+json.unitprice+'</span></div><div class="ub-f1 tx-c"><span>税率：</span><span class="goodsTaxrate">'+json.taxrate+'</span><span>%</span></div><div class="ub-f1 tx-r"><span>金额：</span><span class="goodsTaxprece">'+json.amount+'</span></div></div></div></div>').attr('data-json', jsonStr));
    	}
        return thisItem.html();
	}
	//master信息的保存
	function masterSave(master_backup){
		master_backup['master.billdate']=$('#billDate').val();//日期
		master_backup['master.code']=$('#billCode').val();//单号
		base_index.get_client(master_backup);
		master_backup['master.exemanid']=base_index.getSelectedAttr($('#empName'),'data-id');
		master_backup['master.exemanname']=$('#empName').val();//业务员name
		master_backup['master.departmentid']=base_index.getSelectedAttr($('#depName'),'data-id');//部门id
		master_backup['master.deptname']=$('#dmpName').val();//部门name

		master_backup['master.revdate']=$('#revDate').val();//到货日期
		master_backup['master.memo']=$('#remark').val();  //摘要
		master_backup['master.projectid']=base_index.getSelectedAttr($('#projectName'),'data-id');//项目id
		master_backup['master.projectname']=$('#projectName').val();//项目名称
		 //中止
        if ($('#closed').is(":checked")) {
            master_backup['master.closed'] = 'T';
        } else {
            master_backup['master.closed'] = 'F';
        }
		
	}
	//提交
	$('#submitBtn').on('tap', function(){
		_Public.showLoading();
		masterSave(master_backup);
		var delCount=0;//删除货品的条数
		var edit_addCount=0;//编辑或新增的货品条数
		var cur_detailcount=0;//表示现在选中的货品条数
		var new_detailcount=1;//新增的货品条数
		var oldCount=0;//表示未改动的货品条数
		var detail_data={};//记录当前的detail信息
		//整理要保存时的detail数据
		detail_data=Save_order.get_saveDetail(edit_addCount,type,new_detailcount,delCount,cur_detailcount,oldCount);
		//判断是否选择了其他的供应商
		if(choose_trader){
			$.extend(detail_data['list'],del_detail);
			console.log(detail_data['list']);
			delCount=delDetail_count;
		}
		if(detail_data['cur_detailcount']==0&&detail_data['oldCount']==0){
			 _Public.hideProgress();
			_Public.layerMsg("请选择商品,再进行保存！",2500);
			return;
		}
		master_backup['detail1Count']=detail_data['edit_addCount'];
		master_backup['deletedetail1Count']=detail_data['delCount'];
		master_backup['start']=0;
		master_backup['checkStep']=0;
		master_backup['isH5']=true;
		master_backup['billId']=bill_id;
		if(isAdd){
			//当为新增开单据时
			delete master_backup['id'];
		}
		//master和detail合并
		$.extend(master_backup,detail_data['list']);
		var data={};
		data['url']=saveUrl;
		data['data']=master_backup;
		data['type']='POST';
		console.log(master_backup);
		$.ajax({
            type: data['type'],
            url: data['url'],
            dataType: 'json',
            data: data['data'],
            timeout: 3000,
            success: function (ret) {
                _Public.hideProgress();
                Save_order.showMsg(data,ret,type);
            },
            error: function (xhr, type) {
                _Public.hideProgress();
                _Public.layerMsg('err:'+xhr);
            }
        });

	});

});
</script>
</html>